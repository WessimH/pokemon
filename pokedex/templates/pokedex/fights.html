{% extends 'pokedex/base.html' %}

{% block content %}
<div class="container mx-auto py-10 px-4">

  {% if in_fight %}
  <!-- ================= MODE COMBAT ================= -->
  <div class="max-w-4xl mx-auto">

    <!-- HEADER -->
    <div class="flex justify-between items-center mb-6">
      <h2 class="text-2xl font-bold text-slate-700">Tour {{ state.turn }}</h2>
      <form action="{% url 'fight' %}" method="post">
        {% csrf_token %}
        <input type="hidden" name="action_type" value="quit">
        <button type="submit"
          class="text-red-500 hover:text-red-700 font-bold border border-red-200 hover:bg-red-50 px-4 py-2 rounded-lg transition">
          {% if state.mode == 'pvp' %}Arr√™ter le Duel{% else %}Abandonner{% endif %}
        </button>
      </form>
    </div>

    {% if state.mode == 'pvp' and not state.winner %}
    <div class="mb-4 text-center">
      <span class="px-6 py-2 rounded-full text-lg font-bold border-2
      {% if input_phase == 'p1' %}
        bg-blue-100 text-blue-700 border-blue-300
      {% else %}
        bg-red-100 text-red-700 border-red-300
      {% endif %}
    ">
        Tour de :
        {% if input_phase == 'p1' %}
        {{ state.team1.user.username|default:"Joueur 1" }}
        {% else %}
        {{ state.team2.user.username|default:"Joueur 2" }}
        {% endif %}
      </span>
    </div>
    {% endif %}

    <!-- ARENE -->
    <div class="bg-white rounded-3xl shadow-xl overflow-hidden border border-slate-200 relative mb-8">
      <div class="absolute inset-0 bg-gradient-to-b from-blue-100 to-green-100 opacity-50"></div>

      <!-- ADVERSAIRE -->
      <div class="relative z-10 p-8 flex justify-end border-b border-white/50">
        {% for p in state.team2.pokemons %}
        {% if forloop.counter0 == state.team2.active_index %}
        <div class="text-right">
          <div class="text-2xl font-bold text-slate-700">
            {{ p.name }} <span class="text-sm text-slate-500">Nv.{{ p.level }}</span>
          </div>
          <div class="w-64 bg-slate-200 rounded-full h-4 mt-2 ml-auto overflow-hidden border">
            <div class="bg-red-500 h-full" style="width: {% widthratio p.current_hp p.max_hp 100 %}%"></div>
          </div>
          <div class="text-sm font-mono mt-1">{{ p.current_hp }} / {{ p.max_hp }} HP</div>
          <img
            src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/{{ p.id }}.png"
            class="w-32 h-32 object-contain ml-auto mt-4" alt="{{ p.name }}">
        </div>
        {% endif %}
        {% endfor %}
      </div>

      <!-- JOUEUR -->
      <div class="relative z-10 p-8">
        {% for p in state.team1.pokemons %}
        {% if forloop.counter0 == state.team1.active_index %}
        <div class="flex items-end gap-8">
          <img
            src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/{{ p.id }}.png"
            class="w-48 h-48 object-contain transform -scale-x-100" alt="{{ p.name }}">
          <div class="flex-1">
            <div class="text-2xl font-bold text-slate-700">
              {{ p.name }} <span class="text-sm text-slate-500">Nv.{{ p.level }}</span>
            </div>
            <div class="w-64 bg-slate-200 rounded-full h-4 mt-2 overflow-hidden border">
              <div class="bg-green-500 h-full" style="width: {% widthratio p.current_hp p.max_hp 100 %}%"></div>
            </div>
            <div class="text-sm font-mono mt-1">{{ p.current_hp }} / {{ p.max_hp }} HP</div>
          </div>
        </div>
        {% endif %}
        {% endfor %}
      </div>
    </div>

    <!-- CONTROLES -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">

      <div class="md:col-span-2 bg-white rounded-2xl shadow-lg border p-6">

        {% if state.winner %}
        <div class="text-center py-8">
          <h3 class="text-3xl font-bold mb-4">
            {% if state.winner == "team1" %}üéâ Victoire !{% else %}üíÄ D√©faite...{% endif %}
          </h3>
          <form action="{% url 'fight' %}" method="post">
            {% csrf_token %}
            <input type="hidden" name="action_type" value="quit">
            <button class="bg-blue-600 text-white py-3 px-8 rounded-full">Retour</button>
          </form>
        </div>

        {% else %}
        <form action="{% url 'fight' %}" method="post" class="flex flex-col gap-4">
          {% csrf_token %}
          <input type="hidden" name="action_type" value="turn">

          <button type="submit" name="move" value="attack"
            class="w-full bg-red-500 hover:bg-red-600 text-white text-xl font-bold py-4 rounded-xl">
            üî• ATTAQUER
          </button>

          <p class="text-sm text-slate-500 font-semibold">Changer de Pok√©mon :</p>

          <div class="grid grid-cols-5 gap-2">
            {% for p in state.team1.pokemons %}
              {% if p.fainted or forloop.counter0 == state.team1.active_index %}
                <button type="submit" name="move" value="switch_{{ forloop.counter0 }}" disabled
                  class="p-2 border-2 rounded-lg text-xs font-bold bg-gray-100 text-gray-400 cursor-not-allowed">
                  {{ p.name }}
                </button>
              {% else %}
                <button type="submit" name="move" value="switch_{{ forloop.counter0 }}"
                  class="p-2 border-2 rounded-lg text-xs font-bold bg-white hover:bg-blue-50">
                  {{ p.name }}
                </button>
              {% endif %}
            {% endfor %}
           </div>
        </form>
        {% endif %}
      </div>

      <!-- LOG -->
      <div class="bg-slate-900 rounded-2xl p-4 font-mono text-green-400 overflow-y-auto h-64">
        {% for line in state.log|slice:":-1" %}
        <div>{{ line }}</div>
        {% endfor %}
      </div>

    </div>
  </div>

  {% else %}
  <!-- ================= MODE SELECTION ================= -->
  <div class="max-w-4xl mx-auto py-10">
    <div class="text-center mb-12">
      <h2 class="text-5xl font-extrabold text-slate-800 mb-4">Ar√®ne de Combat</h2>
      <p class="text-lg text-slate-500">Pr√©parez vos Pok√©mons pour la gloire.</p>
    </div>

    <form action="{% url 'fight' %}" method="post" class="space-y-10">
      {% csrf_token %}
      <input type="hidden" name="action_type" value="start">

      <!-- MODE SELECTION -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <label class="relative cursor-pointer group">
          <input type="radio" name="mode" value="pve" class="peer sr-only" checked>
          <div
            class="p-6 bg-white border-2 border-slate-200 rounded-3xl shadow-sm peer-checked:border-blue-500 peer-checked:bg-blue-50 transition-all group-hover:shadow-md">
            <div class="text-4xl mb-2">ü§ñ</div>
            <div class="text-xl font-bold text-slate-700">Adventure (PvE)</div>
            <div class="text-sm text-slate-500 mt-1">D√©fiez un dresseur contr√¥l√© par l'IA.</div>
          </div>
        </label>

        <label class="relative cursor-pointer group">
          <input type="radio" name="mode" value="pvp" class="peer sr-only">
          <div
            class="p-6 bg-white border-2 border-slate-200 rounded-3xl shadow-sm peer-checked:border-red-500 peer-checked:bg-red-50 transition-all group-hover:shadow-md">
            <div class="text-4xl mb-2">‚öîÔ∏è</div>
            <div class="text-xl font-bold text-slate-700">Duel Local (PvP)</div>
            <div class="text-sm text-slate-500 mt-1">Affrontez un ami sur la m√™me machine.</div>
          </div>
        </label>
      </div>

      <!-- TEAM SELECTION -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-10">

        <!-- PLAYER 1 TEAM -->
        <div>
          <h3 class="text-xl font-bold text-slate-700 mb-4 flex items-center gap-2">
            <span class="w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center text-sm">1</span>
            √âquipe Joueur 1
          </h3>
          <div class="space-y-3 max-h-[400px] overflow-y-auto p-2">
            {% for team in teams %}
            <label class="flex items-center p-4 bg-white border-2 border-slate-100 rounded-2xl transition-colors shadow-sm
            {% if team.pokemons.count == 5 %}
                cursor-pointer hover:border-blue-200 has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50
            {% else %}
                opacity-40
            {% endif %}">
                <input type="radio" name="team1_id" value="{{ team.id }}" class="sr-only" 
                    {% if team.pokemons.count == 5 %}
                        {% if forloop.first %}checked{% endif %}
                    {% endif %}>
                <div class="flex-1">
                    <div class="font-bold text-slate-800 flex items-center justify-between">
                    <span>{{ team.name }}</span>
                    <span class="text-xs px-2 py-1 rounded {% if team.pokemons.count == 5 %}bg-green-100 text-green-700{% else %}bg-red-100 text-red-700{% endif %}">
                        {{ team.pokemons.count }}/5
                    </span>
                    </div>
                    <div class="flex gap-1 mt-1">
                    {% for p in team.pokemons.all %}
                        <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/{{ p.pokemon_id }}.png" class="w-8 h-8 object-contain" alt="{{ p.name }}">
                    {% endfor %}
                    </div>
                </div>
            </label>
            {% empty %}
            <div class="text-center py-8 bg-slate-50 rounded-2xl border-2 border-dashed border-slate-200">
              <p class="text-slate-500">Vous n'avez pas encore d'√©quipe.</p>
              <a href="{% url 'team' %}" class="text-blue-500 font-bold hover:underline mt-2 inline-block">Cr√©er une √©quipe</a>
            </div>
            {% endfor %}
          </div>
        </div>

        <!-- PLAYER 2 TEAM (Only for PvP) -->
        <div id="p2_selection" class="opacity-50 pointer-events-none grayscale transition-all duration-300">
          <h3 class="text-xl font-bold text-slate-700 mb-4 flex items-center gap-2">
            <span class="w-8 h-8 bg-red-500 text-white rounded-full flex items-center justify-center text-sm">2</span>
            √âquipe Joueur 2
          </h3>
          <div class="space-y-3 max-h-[400px] overflow-y-auto p-2">
            {% for team in teams %}
            <label class="flex items-center p-4 bg-white border-2 border-slate-100 rounded-2xl transition-colors shadow-sm
            {% if team.pokemons.count == 5 %}
                cursor-pointer hover:border-red-200 has-[:checked]:border-red-500 has-[:checked]:bg-red-50
            {% else %}
                opacity-40
            {% endif %}">
                <input type="radio" name="team2_id" value="{{ team.id }}" class="sr-only" 
                    {% if team.pokemons.count == 5 %}
                        {% if forloop.counter == 2 %}checked{% endif %}
                    {% endif %}>
                <div class="flex-1"> 
                    <div class="font-bold text-slate-800 flex items-center justify-between">
                    <span>{{ team.name }}</span>
                    <span class="text-xs px-2 py-1 rounded {% if team.pokemons.count == 5 %}bg-green-100 text-green-700{% else %}bg-red-100 text-red-700{% endif %}">
                        {{ team.pokemons.count }}/5
                    </span>
                    </div>
                    <div class="flex gap-1 mt-1">
                    {% for p in team.pokemons.all %}
                    <img
                        src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/{{ p.pokemon_id }}.png"
                        class="w-8 h-8 object-contain" alt="{{ p.name }}">
                    {% endfor %}
                    </div>
                </div>
            </label>
            {% endfor %}
          </div>
          <p class="text-xs text-slate-400 mt-4 italic">* Valide uniquement en mode Duel Local.</p>
        </div>
      </div>

      <div class="text-center pt-6">
        <button type="submit"
          class="bg-gradient-to-r from-blue-600 to-indigo-700 text-white text-xl font-bold py-5 px-16 rounded-full shadow-xl hover:scale-105 active:scale-95 transition-transform">
          LANCER LE COMBAT ‚ö°
        </button>
      </div>
    </form>
  </div>

  <script>
    // Logic to enable/disable Player 2 selection based on mode
    const modeRadios = document.querySelectorAll('input[name="mode"]');
    const p2Section = document.getElementById('p2_selection');

    modeRadios.forEach(radio => {
      radio.addEventListener('change', () => {
        if (radio.value === 'pvp') {
          p2Section.classList.remove('opacity-50', 'pointer-events-none', 'grayscale');
          p2Section.querySelectorAll('input').forEach(i => i.required = true);
        } else {
          p2Section.classList.add('opacity-50', 'pointer-events-none', 'grayscale');
          p2Section.querySelectorAll('input').forEach(i => i.required = false);
        }
      });
    });
  </script>
  {% endif %}

</div>
{% endblock %}

